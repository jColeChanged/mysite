(ns mysite.core
  (:use compojure.core, ring.middleware.keyword-params, ring.middleware.params,
	ring.util.response, pour.core, pour.validators)
  (:require [net.cgrand.enlive-html :as html])
  (:require [appengine-magic.core :as ae])
  (:require [appengine-magic.services.datastore :as ds]))
  
;; Models ==================================================================
(ds/defentity Project [^:key title, pitch, details, priority])

(defn add-project-to-store
  [data]
  (let [project (Project. (:title data) (:pitch data) (:details data)
			  (:priority data))]
    (ds/save! project)))

;; Forms ===================================================================
(defform add-project-form
  :title [required "Title is required."]
  :pitch [required "Pitch is required."]
  :details [required "Details are required."]
  :priority [required "A priority is required."
	     an-integer "The priority must be an integer."])

;; Templates ===============================================================
(defn set-input
  [id form]
  (html/set-attr :value (str (id (:values form)))))

(defn set-error
  [id form]
  (html/html-content (id (:errors form))))

(html/deftemplate add-project-template "mysite/projects/add.html"
  [form-data]
  [:div#title :input] (set-input :title form-data)
  [:div#title :p] (set-error :title form-data)
  [:div#pitch :input] (set-input :pitch form-data)
  [:div#pitch :p] (set-error :pitch form-data)
  [:div#details :textarea] (html/html-content (:details (:values form-data)))
  [:div#details :p] (set-error :details form-data)
  [:div#priority :input] (set-input :priority form-data)
  [:div#priority :p] (set-error :priority form-data))

(def *project-selector* [[:.project]])

(html/defsnippet project-snippet "mysite/projects/view.html" *project-selector*
  [project]
  [:h2] (html/html-content (.title project))
  [:p.pitch] (html/html-content (.pitch project))
  [:div.details] (html/html-content (.details project)))

(html/deftemplate view-projects-template "mysite/projects/view.html"
  [projects]
  [:.projects] (html/content (map project-snippet projects)))

;; Views ===================================================================
(defn show-project
  [params]
  (let [form-data (add-project-form params)]
    (if (empty? (:errors form-data))
      (do
	(add-project-to-store (:values form-data))
	(redirect "/projects/view/"))
      (add-project-template form-data))))

(defn view-projects
  []
  (view-projects-template (ds/query :kind Project)))

;; Routes ==================================================================
(defroutes mysite-app-handler
  (GET "/" [] (
  (GET "/projects/add/" [] (add-project-template 0))
  (POST "/projects/add/" {params :params} (show-project params))
  (GET "/projects/view/" [] (view-projects))
  (GET "*" req
       {:status 200
	:headers {"Content-Type" "text/plain"}
	:body "making changes live*"}))

(def mysite-app-handler
     (-> mysite-app-handler
	 wrap-params
	 wrap-keyword-params
	 wrap-params))

(ae/def-appengine-app mysite-app #'mysite-app-handler)